## 概述

* 直播流有白板流和摄像头流
* 每个直播流有`未直播`,`直播中`,`已关闭`三种状态
* `Push Client`在流的直播状态发生改变的时候通知服务器
* `Server`维护流的直播状态
* `Pull Client` 在 `未直播`状态下通过定时从服务器获取来更新流的直播状态
* `Pull Client` 在`直播中`状态下通过播放器的结束回调(end)来更新流的直播状态

## 直播流类型
* 白板流 board
* 摄像头流 camera

## 直播流状态
* `未直播 0`
* `直播中 1`
* `已关闭 2`

## Push Client

Windows控制直播流播放状态，在播放状态发生改变的时候通知服务器

### 直播参数

进入直播室以后调用直播参数接口，获取直播推流地址和直播心跳间隔

> 直播参数获取失败以后重试5次，还没有成功提示`加入直播间异常请稍后再试`

### 开始直播

老师点击开始直播，`Push Client` 调用直播开始接口并带上摄像头和白板的直播状态，如果直播开始的时候白板或者摄像头流默认关闭，流的直播状态应该为: `已关闭 2`而不是 `未直播 0`

> 直播开始失败以后重试5次，还没有成功提示`服务器异常，请稍后再试`

### 直播心跳

直播心跳是为了防止程序异常退出或者网络中断等情况播放`Push Client`不能正确通知服务器状态，服务端做出的被动查询机制

直播心跳也用于记录直播时长

心跳间隔通过调用直播参数接口获取, 根据心跳间隔定时调用心跳接口

> 心跳通知失败后, 在下一次开始心跳之前一直重试. 为了防止服务端重复记录心跳，每次心跳带上时间戳，重试心跳使用相同的时间戳

### 状态切换

在直播没有结束的时候老师手动关闭/打开摄像头或者白板, `Push Client`调用直播状态切换接口通知服务器

> 状态切换失败后如果推流还能够正常工作需要一直重试状态切换通知，直到正确返回

### 结束直播

老师手动结束直播或者程序退出, `Push Client`调用直播结束接口

> 直播结束失败后重试`5`次

## Server

### 初始状态

在没有收到直播开始请求之前，所有流都处于`未直播 0`状态

### 直播参数

返回课程使用的直播推流地址和心跳间隔

### 直播开始

根据`Push Client`传来的直播状态参数更新流的直播状态

### 直播心跳

记录直播时长并更新最后心跳时间，判断心跳时间戳如果小于最后一次心跳则认为是重复心跳或者无效心跳

### 状态切换

收到状态切换请求以后把收到的直播状态更新到缓存中

### 直播结束未

收到直状播结束请求以后删除缓存中对应的直播状态缓存

### 状态查询
1. 收到`Pull Client`查询请求
2. 从缓存中拿到直播流的播放状态, 没有缓存认为是未直播
3. 检查收到的心跳最后时间，如果心跳正常直接返回缓存的直播状态
4. 如果播放状态为播放中并且长时间没有收到心跳认为`Push Client`异常，去网易服务器查询直播状态
5. 返回直播状态给`Pull Client`

## Pull Client

### 状态机

![状态机](https://github.com/chuanjiabao1981/qadoc/raw/master/%E8%BE%85%E5%AF%BC%E7%8F%AD%E7%9B%B4%E6%92%AD%E7%8A%B6%E6%80%81%E6%9C%BA.png)

### 客户端状态
* 初始化
* 未直播
* 直播中
* 已关闭

### 初始化

刚进入页面的时候播放器处于`初始化(未知)`状态，通过调用状态查询接口进入对应状态

### 未直播

`未直播`状态下设置30s一次状态查询任务, 根据查询结果进入其它状态

### 开始直播

状态查询拿到直播流处于`直播中`状态，播放开始, 并且停止对应播放器的状态查询任务

### 直播关闭

收到播放器的`end`信号以后，播放器进入`初始化`状态, 重置播放器, 并进行一次状态查询

### 直播结束

如果播放器处于`已关闭` 状态, 服务器返回`未直播`状态, 播放器进入`未直播`状态

### 状态查询

`初始化`状态下进行一次状态查询

`未直播`或者 `已关闭` 状态下30秒一次查询服务器的直播状态

> 由于存在查询定时任务，查询失败后重试2次


## API定义

### 获取直播参数

```
地址: GET /api/v1/live_studio/lessons/:id/live_info
返回值:
{
  "status": 1,
  "data": {
    "board_push_stream": 'xxxxxxxx', # 白板推流地址
    "camera_push_stream": 'xxxxxxxx', # 摄像头推流地址
    "beat_step": 60 # 心跳步长 单位: 秒
  }
}
```

### 直播开始

```
地址: POST /api/v1/live_studio/lessons/:id/live_start
参数:
{
  board: 1, # 是否开始直播白板. 1: 是, 0: 否
  camera: 1 # 是否开始直播摄像头. 1: 是, 0: 否
}
返回值:
{
  
  "status": 1,
  "data": {
    "status": "teaching", # 课程当前状态, 调用开始之后这个状态是teaching说明开始成功，否则开始失败
    "live_token": "xxxxxxxxxxx" # 用于心跳的token参数
  }
}
```

### 直播心跳

```
地址: POST /api/v1/live_studio/lessons/:id/heart_beat
参数:
{
  live_token: 'xxxxx',
  beat_step: 60
}
返回值:
{
  
  "status": 1,
  "data": {
    "result": "ok",
    "live_token": "yyyyyyyyy" # 如果心跳传递的live_token不可用会返回新的值，否则会返回旧的token
  }
}
```

### 状态切换

```
地址: POST /api/v1/live_studio/lessons/:id/live_switch
参数:
{
  board: 1, # 是否开始直播白板. 1: 是, 0: 否
  camera: 1 # 是否开始直播摄像头. 1: 是, 0: 否
}
返回值:
{
  
  "status": 1,
  "data": {
    "result": "ok"
  }
}
```

### 直播结束

```
地址: POST /api/v1/live_studio/lessons/:id/live_end
返回值:
{
  
  "status": 1,
  "data": {
    "result": "ok",
    "status": "closed" # 课程状态，用于更新本地课程状态
  }
}
```

### 状态查询

```
地址: 
GET /api/v1/live_studio/lessons/:id/live_status
GET /live_studio/lessons/:id/live_status
返回值:
{
  
  "status": 1,
  "data": {
    "board": 1, 
    "camera": 0 
  }
}
```










